<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„Çø„Ç∏„Ç™ - „Éê„É≥„ÉâÊ¥ªÂãïÁÆ°ÁêÜ</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üé∏</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap');
        
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: #1a1a2e;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 232, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 232, 119, 0.2) 0%, transparent 50%);
            color: #ffffff;
            min-height: 100vh;
            margin: 0;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #f093fb 50%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .session-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .session-item {
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .session-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .drop-zone {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(139, 92, 246, 0.1);
            margin: 20px 0;
        }
        
        .drop-zone.drag-over {
            border-color: rgba(139, 92, 246, 1);
            background: rgba(139, 92, 246, 0.2);
        }
        
        .audio-source-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .upload-method-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .upload-method-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .upload-method-selector label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .upload-method-selector input[type="radio"] {
            cursor: pointer;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(139, 92, 246, 0.8);
        }
        
        .btn-primary {
            background: rgba(139, 92, 246, 0.9);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: rgba(139, 92, 246, 1);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea, #f093fb);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyDkO7o1e8PNc9seMoMk3eBytSOIOA_Rqaw",
            authDomain: "band-apps.firebaseapp.com",
            databaseURL: "https://band-apps-default-rtdb.firebaseio.com",
            projectId: "band-apps",
            storageBucket: "band-apps.firebasestorage.app",
            messagingSenderId: "238355659055",
            appId: "1:238355659055:web:d07caffb8b2fd6112689da",
            measurementId: "G-T5ZYHTSS3L"
        };

        let database = null;
        let storage = null;
        let isFirebaseEnabled = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            storage = firebase.storage();
            isFirebaseEnabled = true;
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã
        let currentSession = null;
        let sessions = [];
        let audioSources = [];

        // DOMË¶ÅÁ¥†„Çí‰ΩúÊàê„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function createElement(tag, className, text) {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (text) el.textContent = text;
            return el;
        }

        // „É°„Ç§„É≥ÁîªÈù¢„Çí‰ΩúÊàê
        function createMainScreen() {
            const container = createElement('div', 'min-h-screen p-4');
            
            // „Éò„ÉÉ„ÉÄ„Éº
            const header = createElement('div', 'glass-card mb-6 p-6');
            const headerContent = createElement('div', 'flex justify-between items-center');
            
            const headerLeft = createElement('div');
            const title = createElement('h1', 'text-3xl font-bold gradient-text mb-2', 'üéµ „É¨„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Çø„Ç∏„Ç™');
            headerLeft.appendChild(title);
            
            if (currentSession) {
                const sessionName = createElement('p', 'text-xl', 'ÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥: ' + currentSession.name);
                headerLeft.appendChild(sessionName);
            }
            
            const headerRight = createElement('div', 'flex gap-4');
            
            const newSessionBtn = createElement('button', 'btn-primary', 'Êñ∞Ë¶è„Çª„ÉÉ„Ç∑„Éß„É≥');
            newSessionBtn.onclick = createNewSession;
            
            const homeBtn = createElement('a', 'btn-secondary');
            homeBtn.href = 'home.html';
            homeBtn.textContent = '„Éõ„Éº„É†„Å´Êàª„Çã';
            homeBtn.style.textDecoration = 'none';
            homeBtn.style.display = 'inline-block';
            
            headerRight.appendChild(newSessionBtn);
            headerRight.appendChild(homeBtn);
            
            headerContent.appendChild(headerLeft);
            headerContent.appendChild(headerRight);
            header.appendChild(headerContent);
            container.appendChild(header);
            
            // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ
            const mainGrid = createElement('div', 'grid grid-cols-1 lg:grid-cols-3 gap-6');
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥„É™„Çπ„Éà
            const sessionListCard = createElement('div', 'glass-card p-6');
            const sessionListTitle = createElement('h2', 'text-xl font-bold mb-4', 'ÈÅéÂéª„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥');
            sessionListCard.appendChild(sessionListTitle);
            
            const sessionListContainer = createElement('div', 'session-list');
            sessions.forEach(session => {
                const sessionItem = createSessionItem(session);
                sessionListContainer.appendChild(sessionItem);
            });
            sessionListCard.appendChild(sessionListContainer);
            
            // Èü≥Ê∫êÁÆ°ÁêÜ
            const audioCard = createElement('div', 'glass-card p-6 lg:col-span-2');
            const audioTitle = createElement('h2', 'text-xl font-bold mb-4', 'Èü≥Ê∫êÁÆ°ÁêÜ');
            audioCard.appendChild(audioTitle);
            
            if (currentSession) {
                // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊñπÊ≥ïÈÅ∏Êäû
                if (isFirebaseEnabled) {
                    const uploadMethodDiv = createElement('div', 'upload-method-selector');
                    
                    const methods = [
                        { value: 'auto', label: 'Ëá™ÂãïÔºà10MB‰ª•‰∏ã„ÅØÁõ¥Êé•„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºâ' },
                        { value: 'firebase', label: 'Â∏∏„Å´Firebase„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ' },
                        { value: 'link', label: 'Â§ñÈÉ®„É™„É≥„ÇØ„Çí‰ΩøÁî®' }
                    ];
                    
                    methods.forEach(method => {
                        const label = createElement('label');
                        const radio = createElement('input');
                        radio.type = 'radio';
                        radio.name = 'uploadMethod';
                        radio.value = method.value;
                        if (method.value === 'auto') radio.checked = true;
                        
                        label.appendChild(radio);
                        label.appendChild(document.createTextNode(' ' + method.label));
                        uploadMethodDiv.appendChild(label);
                    });
                    
                    audioCard.appendChild(uploadMethodDiv);
                }
                
                // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥
                const dropZone = createElement('div', 'drop-zone');
                const dropText = createElement('p', 'text-lg mb-2', 'Èü≥Â£∞„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó');
                const orText = createElement('p', 'text-sm text-gray-400 mb-4', '„Åæ„Åü„ÅØ');
                const buttonContainer = createElement('div', 'flex gap-4 justify-center');
                
                if (isFirebaseEnabled) {
                    const fileInput = createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'audio/*';
                    fileInput.multiple = true;
                    fileInput.style.display = 'none';
                    fileInput.id = 'fileInput';
                    fileInput.onchange = handleFileInput;
                    
                    const fileBtn = createElement('button', 'btn-primary', '„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû');
                    fileBtn.onclick = () => fileInput.click();
                    
                    dropZone.appendChild(fileInput);
                    buttonContainer.appendChild(fileBtn);
                }
                
                const linkBtn = createElement('button', 'btn-primary', 'Â§ñÈÉ®„É™„É≥„ÇØ„ÇíËøΩÂä†');
                linkBtn.onclick = showLinkModal;
                buttonContainer.appendChild(linkBtn);
                
                dropZone.appendChild(dropText);
                dropZone.appendChild(orText);
                dropZone.appendChild(buttonContainer);
                
                dropZone.ondrop = handleDrop;
                dropZone.ondragover = (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                };
                dropZone.ondragleave = () => {
                    dropZone.classList.remove('drag-over');
                };
                
                audioCard.appendChild(dropZone);
                
                // Èü≥Ê∫ê„É™„Çπ„Éà
                const audioListTitle = createElement('h3', 'text-lg font-semibold mb-3 mt-6', 'Èü≥Ê∫ê„É™„Çπ„Éà');
                audioCard.appendChild(audioListTitle);
                
                const audioListContainer = createElement('div');
                if (audioSources.length === 0) {
                    const noAudio = createElement('p', 'text-gray-400', '„Åæ„Å†Èü≥Ê∫ê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    audioListContainer.appendChild(noAudio);
                } else {
                    audioSources.forEach((source, index) => {
                        const audioItem = createAudioItem(source, index);
                        audioListContainer.appendChild(audioItem);
                    });
                }
                audioCard.appendChild(audioListContainer);
            } else {
                const noSession = createElement('p', 'text-center text-gray-400 py-8', '„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØ‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                audioCard.appendChild(noSession);
            }
            
            mainGrid.appendChild(sessionListCard);
            mainGrid.appendChild(audioCard);
            container.appendChild(mainGrid);
            
            return container;
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
        function createSessionItem(session) {
            const item = createElement('div', 'session-item' + (currentSession && currentSession.id === session.id ? ' border-2 border-purple-500' : ''));
            
            const content = createElement('div');
            content.style.cursor = 'pointer';
            content.onclick = () => loadSession(session);
            
            const name = createElement('p', 'font-medium', session.name);
            const date = createElement('p', 'text-sm text-gray-400', new Date(session.date).toLocaleDateString('ja-JP'));
            const count = createElement('p', 'text-sm text-gray-400', (session.recordings || []).length + 'ÂÄã„ÅÆÈå≤Èü≥');
            
            content.appendChild(name);
            content.appendChild(date);
            content.appendChild(count);
            
            const deleteBtn = createElement('button', 'text-red-400 hover:text-red-300 text-sm mt-2', 'ÂâäÈô§');
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteSession(session.id);
            };
            
            item.appendChild(content);
            item.appendChild(deleteBtn);
            
            return item;
        }

        // Èü≥Ê∫ê„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
        function createAudioItem(source, index) {
            const item = createElement('div', 'audio-source-item');
            
            const info = createElement('div');
            const name = createElement('p', 'font-medium', source.name);
            const type = createElement('p', 'text-sm text-gray-400');
            
            if (source.type === 'firebase') {
                type.textContent = 'Firebase (' + (source.size / 1024 / 1024).toFixed(1) + 'MB)';
            } else {
                type.textContent = source.type.replace('_', ' ');
            }
            
            info.appendChild(name);
            info.appendChild(type);
            
            const actions = createElement('div', 'flex gap-2');
            
            if (source.url) {
                const playLink = createElement('a', 'text-purple-400 hover:text-purple-300', 'ÂÜçÁîü');
                playLink.href = source.url;
                playLink.target = '_blank';
                playLink.rel = 'noopener noreferrer';
                actions.appendChild(playLink);
            }
            
            const deleteBtn = createElement('button', 'text-red-400 hover:text-red-300', 'ÂâäÈô§');
            deleteBtn.onclick = () => deleteAudioSource(index);
            actions.appendChild(deleteBtn);
            
            item.appendChild(info);
            item.appendChild(actions);
            
            return item;
        }

        // Â§ñÈÉ®„É™„É≥„ÇØ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showLinkModal() {
            const overlay = createElement('div', 'modal-overlay');
            overlay.onclick = () => overlay.remove();
            
            const modal = createElement('div', 'modal-content glass-card');
            modal.onclick = (e) => e.stopPropagation();
            
            const title = createElement('h3', 'text-xl font-bold mb-4', 'Â§ñÈÉ®„É™„É≥„ÇØ„ÇíËøΩÂä†');
            
            const nameInput = createElement('input', 'input-field');
            nameInput.type = 'text';
            nameInput.placeholder = 'Èü≥Ê∫ê„ÅÆÂêçÂâç';
            
            const urlInput = createElement('input', 'input-field');
            urlInput.type = 'url';
            urlInput.placeholder = 'URL (Google Drive, YouTube, SoundCloud „Å™„Å©)';
            
            const info = createElement('div', 'text-sm text-gray-400 mb-4');
            const infoText = createElement('p', '', 'ÂØæÂøú„Çµ„Éº„Éì„Çπ:');
            const list = createElement('ul', 'list-disc list-inside ml-2');
            
            const services = ['Google Drive (ÂÖ±Êúâ„É™„É≥„ÇØ)', 'YouTube', 'SoundCloud', '„Åù„ÅÆ‰ªñ„ÅÆÁõ¥Êé•„É™„É≥„ÇØ'];
            services.forEach(service => {
                const li = createElement('li', '', service);
                list.appendChild(li);
            });
            
            info.appendChild(infoText);
            info.appendChild(list);
            
            const actions = createElement('div', 'flex gap-4');
            
            const addBtn = createElement('button', 'btn-primary flex-1', 'ËøΩÂä†');
            addBtn.onclick = () => {
                if (urlInput.value) {
                    handleExternalLinkAdd(urlInput.value, nameInput.value);
                    overlay.remove();
                }
            };
            
            const cancelBtn = createElement('button', 'btn-secondary flex-1', '„Ç≠„É£„É≥„Çª„É´');
            cancelBtn.onclick = () => overlay.remove();
            
            actions.appendChild(addBtn);
            actions.appendChild(cancelBtn);
            
            modal.appendChild(title);
            modal.appendChild(nameInput);
            modal.appendChild(urlInput);
            modal.appendChild(info);
            modal.appendChild(actions);
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
        function createNewSession() {
            const newSession = {
                name: '„Çª„ÉÉ„Ç∑„Éß„É≥ ' + new Date().toLocaleDateString('ja-JP'),
                date: new Date().toISOString(),
                recordings: []
            };
            
            if (isFirebaseEnabled && database) {
                const newRef = database.ref('sessions').push();
                newRef.set(newSession);
                newSession.id = newRef.key;
            } else {
                newSession.id = Date.now().toString();
                const localSessions = JSON.parse(localStorage.getItem('band_sessions') || '{}');
                localSessions[newSession.id] = newSession;
                localStorage.setItem('band_sessions', JSON.stringify(localSessions));
            }
            
            currentSession = newSession;
            audioSources = [];
            loadSessions();
        }

        function loadSession(session) {
            currentSession = session;
            audioSources = session.recordings || [];
            renderApp();
        }

        function deleteSession(sessionId) {
            if (confirm('„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                if (isFirebaseEnabled && database) {
                    database.ref('sessions/' + sessionId).remove();
                } else {
                    const localSessions = JSON.parse(localStorage.getItem('band_sessions') || '{}');
                    delete localSessions[sessionId];
                    localStorage.setItem('band_sessions', JSON.stringify(localSessions));
                }
                
                if (currentSession && currentSession.id === sessionId) {
                    currentSession = null;
                    audioSources = [];
                }
                
                loadSessions();
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        }

        function handleFileInput(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        async function handleFiles(files) {
            for (const file of files) {
                if (file.type.startsWith('audio/')) {
                    try {
                        const uploadMethod = document.querySelector('input[name="uploadMethod"]:checked');
                        const method = uploadMethod ? uploadMethod.value : 'auto';
                        
                        if (!isFirebaseEnabled || method === 'link') {
                            alert('„Éï„Ç°„Ç§„É´„Äå' + file.name + '„Äç„ÅØÂ§ñÈÉ®„É™„É≥„ÇØ„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            showLinkModal();
                            continue;
                        }
                        
                        if (method === 'auto' && file.size > 10 * 1024 * 1024) {
                            alert('„Éï„Ç°„Ç§„É´„Äå' + file.name + '„Äç„ÅØ' + (file.size / 1024 / 1024).toFixed(1) + 'MB„Åß„Åô„ÄÇÂ§ñÈÉ®„É™„É≥„ÇØ„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            showLinkModal();
                            continue;
                        }
                        
                        if (method === 'firebase' && file.size > 50 * 1024 * 1024) {
                            alert('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºàÊúÄÂ§ß50MBÔºâ');
                            continue;
                        }
                        
                        const storageRef = storage.ref();
                        const audioRef = storageRef.child('audio/' + Date.now() + '_' + file.name);
                        const snapshot = await audioRef.put(file);
                        const downloadURL = await snapshot.ref.getDownloadURL();
                        
                        const audioData = {
                            type: 'firebase',
                            url: downloadURL,
                            name: file.name,
                            size: file.size,
                            duration: null
                        };
                        
                        audioSources.push(audioData);
                        saveToSession();
                    } catch (error) {
                        alert('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº: ' + error.message);
                    }
                }
            }
        }

        function handleExternalLinkAdd(url, name) {
            const audioData = {
                type: detectSourceType(url),
                url: processUrl(url),
                name: name || extractFileName(url),
                size: null,
                duration: null
            };
            
            audioSources.push(audioData);
            saveToSession();
        }

        function detectSourceType(url) {
            if (url.includes('drive.google.com')) return 'google_drive';
            if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
            if (url.includes('soundcloud.com')) return 'soundcloud';
            return 'external_url';
        }

        function processUrl(url) {
            if (url.includes('drive.google.com')) {
                const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (match) {
                    return 'https://drive.google.com/uc?export=download&id=' + match[1];
                }
            }
            return url;
        }

        function extractFileName(url) {
            try {
                const urlObj = new URL(url);
                const pathname = urlObj.pathname;
                const parts = pathname.split('/');
                return decodeURIComponent(parts[parts.length - 1]) || 'Â§ñÈÉ®Èü≥Ê∫ê';
            } catch {
                return 'Â§ñÈÉ®Èü≥Ê∫ê';
            }
        }

        function deleteAudioSource(index) {
            audioSources.splice(index, 1);
            saveToSession();
        }

        function saveToSession() {
            if (!currentSession) return;
            
            currentSession.recordings = audioSources;
            
            if (isFirebaseEnabled && database) {
                database.ref('sessions/' + currentSession.id + '/recordings').set(audioSources);
            } else {
                const localSessions = JSON.parse(localStorage.getItem('band_sessions') || '{}');
                localSessions[currentSession.id] = currentSession;
                localStorage.setItem('band_sessions', JSON.stringify(localSessions));
            }
            
            renderApp();
        }

        function loadSessions() {
            if (isFirebaseEnabled && database) {
                database.ref('sessions').on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    sessions = Object.entries(data).map(([id, session]) => ({
                        id: id,
                        ...session
                    }));
                    sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    renderApp();
                });
            } else {
                const localSessions = JSON.parse(localStorage.getItem('band_sessions') || '{}');
                sessions = Object.entries(localSessions).map(([id, session]) => ({
                    id: id,
                    ...session
                }));
                sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderApp();
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderApp() {
            const root = document.getElementById('root');
            root.innerHTML = '';
            root.appendChild(createMainScreen());
        }

        // ÂàùÊúüÂåñ
        loadSessions();
    </script>
</body>
</html>
