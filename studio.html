<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„Çø„Ç∏„Ç™ - „Éê„É≥„ÉâÊ¥ªÂãïÁÆ°ÁêÜ</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üé∏</text></svg>">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap');
        
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: #1a1a2e;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 232, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 232, 119, 0.2) 0%, transparent 50%);
            color: #ffffff;
            min-height: 100vh;
            margin: 0;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #f093fb 50%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .session-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .session-item {
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .session-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .drop-zone {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(139, 92, 246, 0.1);
            margin: 20px 0;
        }
        
        .drop-zone.drag-over {
            border-color: rgba(139, 92, 246, 1);
            background: rgba(139, 92, 246, 0.2);
        }
        
        .audio-source-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .upload-method-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .upload-method-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .upload-method-selector label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .upload-method-selector input[type="radio"] {
            cursor: pointer;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(139, 92, 246, 0.8);
        }
        
        .btn-primary {
            background: rgba(139, 92, 246, 0.9);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: rgba(139, 92, 246, 1);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea, #f093fb);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        (() => {
            const { useState, useEffect, useRef } = React;

            const firebaseConfig = {
                apiKey: "AIzaSyDkO7o1e8PNc9seMoMk3eBytSOIOA_Rqaw",
                authDomain: "band-apps.firebaseapp.com",
                databaseURL: "https://band-apps-default-rtdb.firebaseio.com",
                projectId: "band-apps",
                storageBucket: "band-apps.firebasestorage.app",
                messagingSenderId: "238355659055",
                appId: "1:238355659055:web:d07caffb8b2fd6112689da",
                measurementId: "G-T5ZYHTSS3L"
            };

            let database = null;
            let storage = null;
            let auth = null;
            
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                storage = firebase.storage();
                auth = firebase.auth();
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }

            const AudioManager = {
                MAX_DIRECT_UPLOAD_SIZE: 10 * 1024 * 1024, // 10MB
                
                SOURCE_TYPE: {
                    FIREBASE: 'firebase',
                    GOOGLE_DRIVE: 'google_drive',
                    YOUTUBE: 'youtube',
                    SOUNDCLOUD: 'soundcloud',
                    EXTERNAL_URL: 'external_url'
                },
                
                async handleAudioUpload(file, method = 'auto') {
                    if (method === 'auto') {
                        if (file.size <= this.MAX_DIRECT_UPLOAD_SIZE) {
                            return await this.uploadToFirebase(file);
                        } else {
                            return { needsExternalLink: true };
                        }
                    }
                    
                    if (method === 'firebase') {
                        return await this.uploadToFirebase(file);
                    }
                    
                    return { needsExternalLink: true };
                },
                
                async uploadToFirebase(file) {
                    const storageRef = storage.ref();
                    const audioRef = storageRef.child(`audio/${Date.now()}_${file.name}`);
                    const snapshot = await audioRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    return {
                        type: this.SOURCE_TYPE.FIREBASE,
                        url: downloadURL,
                        name: file.name,
                        size: file.size,
                        duration: null
                    };
                },
                
                detectSourceType(url) {
                    if (url.includes('drive.google.com')) {
                        return this.SOURCE_TYPE.GOOGLE_DRIVE;
                    } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        return this.SOURCE_TYPE.YOUTUBE;
                    } else if (url.includes('soundcloud.com')) {
                        return this.SOURCE_TYPE.SOUNDCLOUD;
                    }
                    return this.SOURCE_TYPE.EXTERNAL_URL;
                },
                
                convertGoogleDriveUrl(shareUrl) {
                    const match = shareUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    if (match) {
                        const fileId = match[1];
                        return `https://drive.google.com/uc?export=download&id=${fileId}`;
                    }
                    return shareUrl;
                },
                
                processExternalLink(url, name) {
                    const sourceType = this.detectSourceType(url);
                    let processedUrl = url;
                    
                    if (sourceType === this.SOURCE_TYPE.GOOGLE_DRIVE) {
                        processedUrl = this.convertGoogleDriveUrl(url);
                    }
                    
                    return {
                        type: sourceType,
                        url: processedUrl,
                        name: name || this.extractFileName(url),
                        size: null,
                        duration: null
                    };
                },
                
                extractFileName(url) {
                    const parts = url.split('/');
                    return parts[parts.length - 1] || 'Â§ñÈÉ®Èü≥Ê∫ê';
                }
            };

            const StudioApp = () => {
                const [sessions, setSessions] = useState([]);
                const [currentSession, setCurrentSession] = useState(null);
                const [audioSources, setAudioSources] = useState([]);
                const [uploadMethod, setUploadMethod] = useState('auto');
                const [showLinkModal, setShowLinkModal] = useState(false);
                const [externalLink, setExternalLink] = useState('');
                const [externalLinkName, setExternalLinkName] = useState('');
                const [uploading, setUploading] = useState(false);
                const [dragOver, setDragOver] = useState(false);

                useEffect(() => {
                    if (!database) return;
                    
                    const sessionsRef = database.ref('sessions');
                    sessionsRef.on('value', (snapshot) => {
                        const data = snapshot.val() || {};
                        const sessionsArray = Object.entries(data).map(([id, session]) => ({
                            id,
                            ...session
                        }));
                        setSessions(sessionsArray.sort((a, b) => new Date(b.date) - new Date(a.date)));
                    });

                    return () => sessionsRef.off();
                }, []);

                const createNewSession = () => {
                    const newSession = {
                        name: `„Çª„ÉÉ„Ç∑„Éß„É≥ ${new Date().toLocaleDateString('ja-JP')}`,
                        date: new Date().toISOString(),
                        recordings: []
                    };
                    
                    if (database) {
                        const newRef = database.ref('sessions').push();
                        newRef.set(newSession);
                        setCurrentSession({ id: newRef.key, ...newSession });
                        setAudioSources([]);
                    }
                };

                const handleDrop = async (e) => {
                    e.preventDefault();
                    setDragOver(false);
                    
                    const files = Array.from(e.dataTransfer.files);
                    
                    for (const file of files) {
                        if (file.type.startsWith('audio/')) {
                            setUploading(true);
                            try {
                                const result = await AudioManager.handleAudioUpload(file, uploadMethod);
                                
                                if (result.needsExternalLink) {
                                    alert(`„Éï„Ç°„Ç§„É´„Äå${file.name}„Äç„ÅØ${(file.size / 1024 / 1024).toFixed(1)}MB„Åß„Åô„ÄÇÂ§ñÈÉ®„É™„É≥„ÇØ„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                                    setShowLinkModal(true);
                                } else {
                                    setAudioSources(prev => [...prev, result]);
                                    saveToSession(result);
                                }
                            } catch (error) {
                                console.error('Upload error:', error);
                                alert('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº: ' + error.message);
                            } finally {
                                setUploading(false);
                            }
                        }
                    }
                };

                const handleExternalLinkAdd = () => {
                    if (!externalLink) return;
                    
                    const audioData = AudioManager.processExternalLink(externalLink, externalLinkName);
                    setAudioSources(prev => [...prev, audioData]);
                    saveToSession(audioData);
                    
                    setShowLinkModal(false);
                    setExternalLink('');
                    setExternalLinkName('');
                };

                const saveToSession = (audioData) => {
                    if (!currentSession || !database) return;
                    
                    const recordings = [...(currentSession.recordings || []), audioData];
                    database.ref(`sessions/${currentSession.id}/recordings`).set(recordings);
                };

                const loadSession = (session) => {
                    setCurrentSession(session);
                    setAudioSources(session.recordings || []);
                };

                const deleteAudioSource = (index) => {
                    const newSources = audioSources.filter((_, i) => i !== index);
                    setAudioSources(newSources);
                    
                    if (currentSession && database) {
                        database.ref(`sessions/${currentSession.id}/recordings`).set(newSources);
                    }
                };

                return (
                    <div className="min-h-screen p-4">
                        <header className="glass-card mb-6 p-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold gradient-text mb-2">
                                        üéµ „É¨„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Çø„Ç∏„Ç™
                                    </h1>
                                    {currentSession && (
                                        <p className="text-xl">
                                            ÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥: {currentSession.name}
                                        </p>
                                    )}
                                </div>
                                <div className="flex gap-4">
                                    <button
                                        onClick={createNewSession}
                                        className="btn-primary"
                                    >
                                        Êñ∞Ë¶è„Çª„ÉÉ„Ç∑„Éß„É≥
                                    </button>
                                    <a
                                        href="home.html"
                                        className="btn-secondary"
                                        style={{ textDecoration: 'none', display: 'inline-block' }}
                                    >
                                        „Éõ„Éº„É†„Å´Êàª„Çã
                                    </a>
                                </div>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="glass-card p-6">
                                <h2 className="text-xl font-bold mb-4">ÈÅéÂéª„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥</h2>
                                <div className="session-list">
                                    {sessions.map(session => (
                                        <div
                                            key={session.id}
                                            className={`session-item ${currentSession?.id === session.id ? 'border-2 border-purple-500' : ''}`}
                                            onClick={() => loadSession(session)}
                                        >
                                            <p className="font-medium">{session.name}</p>
                                            <p className="text-sm text-gray-400">
                                                {new Date(session.date).toLocaleDateString('ja-JP')}
                                            </p>
                                            <p className="text-sm text-gray-400">
                                                {(session.recordings || []).length}ÂÄã„ÅÆÈå≤Èü≥
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="glass-card p-6 lg:col-span-2">
                                <h2 className="text-xl font-bold mb-4">Èü≥Ê∫êÁÆ°ÁêÜ</h2>
                                
                                {currentSession ? (
                                    <>
                                        <div className="upload-method-selector">
                                            <label>
                                                <input 
                                                    type="radio" 
                                                    value="auto" 
                                                    checked={uploadMethod === 'auto'}
                                                    onChange={(e) => setUploadMethod(e.target.value)}
                                                />
                                                Ëá™ÂãïÔºà10MB‰ª•‰∏ã„ÅØÁõ¥Êé•„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºâ
                                            </label>
                                            <label>
                                                <input 
                                                    type="radio" 
                                                    value="firebase" 
                                                    checked={uploadMethod === 'firebase'}
                                                    onChange={(e) => setUploadMethod(e.target.value)}
                                                />
                                                Â∏∏„Å´Firebase„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                                            </label>
                                            <label>
                                                <input 
                                                    type="radio" 
                                                    value="link" 
                                                    checked={uploadMethod === 'link'}
                                                    onChange={(e) => setUploadMethod(e.target.value)}
                                                />
                                                Â§ñÈÉ®„É™„É≥„ÇØ„Çí‰ΩøÁî®
                                            </label>
                                        </div>
                                        
                                        <div 
                                            className={`drop-zone ${dragOver ? 'drag-over' : ''}`}
                                            onDrop={handleDrop}
                                            onDragOver={(e) => {
                                                e.preventDefault();
                                                setDragOver(true);
                                            }}
                                            onDragLeave={() => setDragOver(false)}
                                        >
                                            {uploading ? (
                                                <p>„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...</p>
                                            ) : (
                                                <>
                                                    <p className="text-lg mb-2">Èü≥Â£∞„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</p>
                                                    <p className="text-sm text-gray-400 mb-4">„Åæ„Åü„ÅØ</p>
                                                    <button 
                                                        onClick={() => setShowLinkModal(true)}
                                                        className="btn-primary"
                                                    >
                                                        Â§ñÈÉ®„É™„É≥„ÇØ„ÇíËøΩÂä†
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                        
                                        <div className="mt-6">
                                            <h3 className="text-lg font-semibold mb-3">Èü≥Ê∫ê„É™„Çπ„Éà</h3>
                                            {audioSources.length === 0 ? (
                                                <p className="text-gray-400">„Åæ„Å†Èü≥Ê∫ê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                            ) : (
                                                audioSources.map((source, index) => (
                                                    <div key={index} className="audio-source-item">
                                                        <div>
                                                            <p className="font-medium">{source.name}</p>
                                                            <p className="text-sm text-gray-400">
                                                                {source.type === 'firebase' 
                                                                    ? `Firebase (${(source.size / 1024 / 1024).toFixed(1)}MB)`
                                                                    : source.type.replace('_', ' ')
                                                                }
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {source.url && (
                                                                <a 
                                                                    href={source.url} 
                                                                    target="_blank" 
                                                                    rel="noopener noreferrer"
                                                                    className="text-purple-400 hover:text-purple-300"
                                                                >
                                                                    ÂÜçÁîü
                                                                </a>
                                                            )}
                                                            <button
                                                                onClick={() => deleteAudioSource(index)}
                                                                className="text-red-400 hover:text-red-300"
                                                            >
                                                                ÂâäÈô§
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <p className="text-center text-gray-400 py-8">
                                        „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØ‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                                    </p>
                                )}
                            </div>
                        </div>

                        {showLinkModal && (
                            <div className="modal-overlay" onClick={() => setShowLinkModal(false)}>
                                <div className="modal-content glass-card" onClick={(e) => e.stopPropagation()}>
                                    <h3 className="text-xl font-bold mb-4">Â§ñÈÉ®„É™„É≥„ÇØ„ÇíËøΩÂä†</h3>
                                    
                                    <input
                                        type="text"
                                        placeholder="Èü≥Ê∫ê„ÅÆÂêçÂâç"
                                        value={externalLinkName}
                                        onChange={(e) => setExternalLinkName(e.target.value)}
                                        className="input-field"
                                    />
                                    
                                    <input
                                        type="url"
                                        placeholder="URL (Google Drive, YouTube, SoundCloud „Å™„Å©)"
                                        value={externalLink}
                                        onChange={(e) => setExternalLink(e.target.value)}
                                        className="input-field"
                                    />
                                    
                                    <div className="text-sm text-gray-400 mb-4">
                                        <p>ÂØæÂøú„Çµ„Éº„Éì„Çπ:</p>
                                        <ul className="list-disc list-inside ml-2">
                                            <li>Google Drive (ÂÖ±Êúâ„É™„É≥„ÇØ)</li>
                                            <li>YouTube</li>
                                            <li>SoundCloud</li>
                                            <li>„Åù„ÅÆ‰ªñ„ÅÆÁõ¥Êé•„É™„É≥„ÇØ</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="flex gap-4">
                                        <button
                                            onClick={handleExternalLinkAdd}
                                            className="btn-primary flex-1"
                                        >
                                            ËøΩÂä†
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowLinkModal(false);
                                                setExternalLink('');
                                                setExternalLinkName('');
                                            }}
                                            className="btn-secondary flex-1"
                                        >
                                            „Ç≠„É£„É≥„Çª„É´
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<StudioApp />);
        })();
    </script>
</body>
</html>
